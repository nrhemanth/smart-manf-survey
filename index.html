<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Smart Manufacturing Impact – Battery Production (Single Page)</title>
<style>
  :root{--bg:#f3f4f6;--panel:#ffffff;--text:#1f2937;--muted:#6b7280;--line:#e5e7eb;--brand:#374151;--pos:#10b981;--neg:#ef4444;--neutral:#9ca3af}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:1200px;margin:24px auto;padding:16px}
  h1{margin:0 0 8px 0;font-size:clamp(20px,3vw,28px)}
  p{margin:6px 0;color:var(--muted)}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px;margin:12px 0}
  .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .badge{border:1px solid var(--line);background:#f9fafb;border-radius:999px;padding:6px 10px;font-size:12px;color:#374151}
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid var(--line);padding:8px;font-weight:600}
  tbody tr{background:#fafafa;border:1px solid var(--line)}
  tbody th, tbody td{padding:8px;vertical-align:top}
  tbody th{white-space:nowrap;text-align:left}

  /* Slider */
  .cell{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
  .slider{width:100%;height:8px;border-radius:999px;appearance:none;background:linear-gradient(90deg,#d1d5db,#d1d5db);outline:none}
  .slider::-webkit-slider-thumb{appearance:none;width:20px;height:20px;border-radius:50%;background:#374151;box-shadow:0 0 0 2px #fff inset;cursor:pointer}
  .slider::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:#374151;border:none}
  .ticks{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-top:4px}
  .val{min-width:64px;text-align:right;font-variant-numeric:tabular-nums}
  .naRow{display:flex;align-items:center;gap:6px;margin-top:4px;font-size:12px;color:var(--muted)}

  .grid{display:grid;gap:10px}
  .cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:1000px){.cols-2{grid-template-columns:1fr}}

  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px}
  button{border-radius:10px;border:1px solid var(--line);background:#111827;color:#fff;padding:10px 14px;cursor:pointer}
  button.secondary{background:#4b5563}
  .note{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <header class="card">
      <h1>Smart Manufacturing Impact on Battery Production</h1>
      <p>Estimate the <strong>percentage change in cost</strong> attributable to each capability for each cost parameter. Use <strong>negative values for cost reduction</strong> and <strong>positive values for cost increase</strong>. Sliders range from −20% to +20% by default.</p>
      <div class="legend">
        <span class="badge">Capabilities: Predictive Maintenance, Predictive Quality, Energy Optimization, Traceability, Digital Production Planning, Virtual Commissioning, Materials Flow Optimization</span>
        <span class="badge">Cost parameters: Raw Material, Manufacturing, Energy, Labor, Maintenance & Repair, Scrap & Waste</span>
      </div>
    </header>

    <section class="card" id="matrix_all">
      <h2 style="margin:0 0 10px">Impact Matrix (single page)</h2>
      <div class="grid cols-2" id="matrices"></div>
      <div class="toolbar">
        <button id="downloadCsv">Download CSV</button>
        <button class="secondary" id="copyJson">Copy JSON</button>
        <span id="status" class="note" role="status"></span>
      </div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 6px">Notes / Assumptions (optional)</h3>
      <textarea id="notes" rows="4" style="width:100%;border:1px solid var(--line);border-radius:10px;padding:8px"></textarea>
    </section>
  </div>

<script>
  // ===== Config =====
  const CAPABILITIES = [
    'Predictive Maintenance','Predictive Quality','Energy Optimization','Traceability','Digital Production Planning','Virtual Commissioning','Materials Flow Optimization'
  ];
  const COSTS = ['Raw Material','Manufacturing','Energy','Labor','Maintenance & Repair','Scrap & Waste'];
  const PROCESSES = [
    {key:'electrode', title:'Process: Electrode Fabrication'},
    {key:'assembly', title:'Process: Cell Assembly'},
    {key:'formation', title:'Process: Formation & Testing'},
  ];
  const SL_MIN=-20, SL_MAX=20, SL_STEP=1, DEFAULT=0;

  // ===== Build stacked matrices =====
  const mount = document.getElementById('matrices');
  PROCESSES.forEach(proc=>{
    const card = document.createElement('div'); card.className='card'; card.style.margin='0';
    const h = document.createElement('h3'); h.textContent = proc.title; h.style.margin='0 0 8px'; card.appendChild(h);
    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const thr = document.createElement('tr');
    const th0 = document.createElement('th'); th0.textContent='Capability \\ Cost Parameter'; thr.appendChild(th0);
    COSTS.forEach(c=>{ const th=document.createElement('th'); th.textContent=c; thr.appendChild(th); });
    thead.appendChild(thr); table.appendChild(thead);
    const tbody = document.createElement('tbody');

    CAPABILITIES.forEach((cap,i)=>{
      const tr=document.createElement('tr');
      const th=document.createElement('th'); th.textContent=cap; tr.appendChild(th);
      COSTS.forEach((cp,j)=>{
        const td=document.createElement('td'); td.appendChild(makeCell(`${proc.key}_${i}_${j}`)); tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    card.appendChild(table);
    mount.appendChild(card);
  });

  function makeCell(name){
    const cell=document.createElement('div'); cell.className='cell';
    const left=document.createElement('div');
    const slider=document.createElement('input'); slider.type='range'; slider.min=SL_MIN; slider.max=SL_MAX; slider.step=SL_STEP; slider.value=DEFAULT; slider.className='slider'; slider.name=name;
    const ticks=document.createElement('div'); ticks.className='ticks'; ['−20','−10','0','10','20'].forEach(t=>{const s=document.createElement('span'); s.textContent=(t>0?'+':'')+t; ticks.appendChild(s);});
    left.appendChild(slider); left.appendChild(ticks);

    const right=document.createElement('div');
    const val=document.createElement('div'); val.className='val'; val.textContent=fmt(slider.value);
    const naRow=document.createElement('div'); naRow.className='naRow';
    const na=document.createElement('input'); na.type='checkbox'; na.id=name+'_na';
    const lab=document.createElement('label'); lab.htmlFor=na.id; lab.textContent='N/A';
    naRow.appendChild(na); naRow.appendChild(lab);
    right.appendChild(val); right.appendChild(naRow);

    slider.addEventListener('input', ()=>{ val.textContent=fmt(slider.value); colorSlider(slider); });
    na.addEventListener('change', ()=>{ slider.disabled=na.checked; val.textContent = na.checked? 'N/A' : fmt(slider.value); });

    colorSlider(slider);

    cell.appendChild(left); cell.appendChild(right);
    return cell;
  }

  function fmt(v){ v=Number(v)||0; return (v>0?'+':'')+v+'%'; }

  // Dynamic slider coloring: green when <0, red when >0, grey at 0
  function colorSlider(sl){
    const v = Number(sl.value)||0; const min = Number(sl.min), max = Number(sl.max);
    const pct = (v - min) / (max - min) * 100; // 0..100
    let color = 'var(--neutral)';
    if (v<0) color='var(--pos)';
    else if (v>0) color='var(--neg)';
    sl.style.background = `linear-gradient(90deg, ${color} 0% , ${color} ${pct}%, #d1d5db ${pct}%, #d1d5db 100%)`;
  }

  // ===== Export =====
  function gather(){
    const rows=[];
    PROCESSES.forEach(p=>{
      CAPABILITIES.forEach((cap,i)=>{
        COSTS.forEach((cp,j)=>{
          const name=`${p.key}_${i}_${j}`;
          const slider=document.querySelector(`input[name="${name}"]`);
          const na=document.getElementById(name+'_na');
          rows.push({process:p.title, capability:cap, cost_parameter:cp, value: na&&na.checked? 'N/A' : Number(slider.value)});
        });
      });
    });
    return {meta:{notes:document.getElementById('notes').value.trim(), ts:new Date().toISOString(), range:`${SL_MIN}..${SL_MAX}`}, rows};
  }
  function toCSV(data){
    const header=['timestamp','process','capability','cost_parameter','value','notes'];
    const lines=[header.join(',')];
    data.rows.forEach(r=>{lines.push([data.meta.ts, esc(r.process), esc(r.capability), esc(r.cost_parameter), esc(r.value), esc(data.meta.notes)].join(','));});
    return lines.join('\n');
  }
  function esc(s){ if(s==null) return ''; s=String(s); return /[",\n]/.test(s)? '"'+s.replace(/"/g,'""')+'"' : s; }
  function download(name,content,type){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([content],{type})); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),800); }

  document.getElementById('downloadCsv').onclick=()=>{const d=gather(); download(`smart_mfg_single_${new Date().toISOString().slice(0,10)}.csv`, toCSV(d), 'text/csv'); setStatus('CSV downloaded.');};
  document.getElementById('copyJson').onclick=async()=>{const d=gather(); const j=JSON.stringify(d,null,2); try{await navigator.clipboard.writeText(j); setStatus('JSON copied.', true);}catch(e){ download(`smart_mfg_single_${new Date().toISOString().slice(0,10)}.json`, j, 'application/json'); setStatus('JSON downloaded.'); }};
  function setStatus(m, ok){ const s=document.getElementById('status'); s.textContent=m; s.className = ok? 'note' : 'note'; }
</script>
</body>
</html>
